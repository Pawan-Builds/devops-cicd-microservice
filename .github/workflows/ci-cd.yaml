name: ci-cd

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-application:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify repository structure
        run: |
          echo "üìÅ Checking repository structure..."
          ls -la
          echo "‚úÖ Root directory verified"
          
          echo "üìÅ Checking app directory..."
          ls -la app/
          echo "‚úÖ App directory verified"
          
          echo "üìÅ Checking scripts..."
          ls -la scripts/
          echo "‚úÖ Scripts directory verified"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          cd app
          pip install -r requirements.txt

      - name: Test application syntax
        run: |
          cd app
          echo "üîç Testing Flask application..."
          python -c "from app import app; print('‚úÖ Flask app imports successfully')"
          
          echo "üîç Checking for syntax errors..."
          python -m py_compile app.py
          echo "‚úÖ No syntax errors found"
          
          echo "üîç Testing health endpoint..."
          python -c "
          from app import app
          import sys
          with app.test_client() as client:
              response = client.get('/health')
              if response.status_code == 200:
                  print('‚úÖ Health endpoint returns 200')
              else:
                  print('‚ùå Health endpoint failed')
                  sys.exit(1)
          "

  test-docker-build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker
        run: |
          sudo apt-get update
          sudo apt-get install -y docker.io

      - name: Build Docker image
        run: |
          echo "üê≥ Building Docker image..."
          cd app
          docker build -t devops-cicd-microservice:test .
          echo "‚úÖ Docker build successful"

      - name: Test Docker image
        run: |
          echo "üß™ Testing Docker image..."
          docker run --rm -d -p 5000:5000 --name test-container devops-cicd-microservice:test
          sleep 5
          
          # Test if container is running
          if docker ps | grep -q test-container; then
            echo "‚úÖ Docker container is running"
            
            # Test health endpoint
            if curl -s http://localhost:5000/health | grep -q "ok"; then
              echo "‚úÖ Health endpoint is accessible"
            else
              echo "‚ùå Health endpoint failed"
              docker logs test-container
              exit 1
            fi
            
            docker stop test-container
          else
            echo "‚ùå Docker container failed to start"
            docker logs test-container
            exit 1
          fi

  test-deployment-script:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify deployment script
        run: |
          echo "üîç Checking local-deploy.sh script..."
          
          # Check if script exists
          if [ -f ./scripts/local-deploy.sh ]; then
            echo "‚úÖ Script exists"
            
            # Check if script is executable
            if [ -x ./scripts/local-deploy.sh ]; then
              echo "‚úÖ Script is executable"
            else
              echo "‚ö†Ô∏è  Script is not executable, making it executable..."
              chmod +x ./scripts/local-deploy.sh
            fi
            
            # Check script syntax
            if bash -n ./scripts/local-deploy.sh; then
              echo "‚úÖ Script has valid bash syntax"
            else
              echo "‚ùå Script has bash syntax errors"
              exit 1
            fi
            
            # Check for required commands in script
            echo "üîç Checking for required commands in script..."
            REQUIRED_COMMANDS=("kubectl" "helm" "docker" "minikube")
            for cmd in "${REQUIRED_COMMANDS[@]}"; do
              if grep -q "$cmd" ./scripts/local-deploy.sh; then
                echo "‚úÖ Script uses $cmd"
              else
                echo "‚ö†Ô∏è  Script doesn't use $cmd (might be missing)"
              fi
            done
            
          else
            echo "‚ùå Script not found at ./scripts/local-deploy.sh"
            exit 1
          fi

      - name: Verify Helm chart
        run: |
          echo "üîç Checking Helm chart structure..."
          
          # Check if helm directory exists
          if [ -d ./helm/microservice ]; then
            echo "‚úÖ Helm chart directory exists"
            
            # Check required files
            REQUIRED_FILES=("Chart.yaml" "values.yaml" "templates/deployment.yaml" "templates/service.yaml")
            for file in "${REQUIRED_FILES[@]}"; do
              if [ -f "./helm/microservice/$file" ]; then
                echo "‚úÖ Found $file"
              else
                echo "‚ùå Missing $file"
                exit 1
              fi
            done
            
            # Test Helm template rendering
            echo "üîç Testing Helm template rendering..."
            if helm template ./helm/microservice --dry-run > /dev/null 2>&1; then
              echo "‚úÖ Helm template renders successfully"
            else
              echo "‚ùå Helm template has errors"
              helm template ./helm/microservice --dry-run
              exit 1
            fi
          else
            echo "‚ùå Helm chart not found"
            exit 1
          fi

  verify-readme:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check README instructions
        run: |
          echo "üìñ Verifying README instructions..."
          
          # Check if README exists
          if [ -f README.md ]; then
            echo "‚úÖ README.md exists"
            
            # Check for key instructions
            KEY_PHRASES=(
              "git clone"
              "minikube start"
              "local-deploy.sh"
              "minikube service"
            )
            
            for phrase in "${KEY_PHRASES[@]}"; do
              if grep -q "$phrase" README.md; then
                echo "‚úÖ README contains: $phrase"
              else
                echo "‚ö†Ô∏è  README missing: $phrase"
              fi
            done
            
            # Check for exact clone command
            if grep -q "git clone https://github.com/Pawan-Builds/devops-cicd-microservice.git" README.md; then
              echo "‚úÖ README has correct clone command"
            else
              echo "‚ùå README missing correct clone command"
            fi
            
          else
            echo "‚ùå README.md not found"
            exit 1
          fi

      - name: Generate deployment summary
        run: |
          echo "üìã DEPLOYMENT INSTRUCTIONS SUMMARY"
          echo "=================================="
          echo ""
          echo "‚úÖ Repository structure is valid"
          echo "‚úÖ Python application works"
          echo "‚úÖ Docker image builds successfully"
          echo "‚úÖ Deployment script is ready"
          echo "‚úÖ Helm charts are valid"
          echo "‚úÖ README has deployment instructions"
          echo ""
          echo "üìù Users can deploy using:"
          echo ""
          echo "  git clone https://github.com/Pawan-Builds/devops-cicd-microservice.git"
          echo "  cd devops-cicd-microservice"
          echo "  minikube start"
          echo "  ./scripts/local-deploy.sh"
          echo "  minikube service microservice -n devops-demo"
EOF
