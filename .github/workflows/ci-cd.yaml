name: ci-cd

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-application:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          cd app
          pip install -r requirements.txt

      - name: Test application
        run: |
          cd app
          python -c "from app import app; print('‚úÖ Flask app imports successfully')"
          echo "‚úÖ Application test passed"

  test-docker-build:
    runs-on: ubuntu-latest
    needs: test-application
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          echo "üê≥ Building Docker image..."
          cd app
          docker build -t devops-cicd-microservice:test .
          echo "‚úÖ Docker build successful"

  test-deployment-script:
    runs-on: ubuntu-latest
    needs: test-application
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify deployment script
        run: |
          echo "üîç Checking deployment scripts..."
          if [ -f "scripts/local-deploy.sh" ]; then
            echo "‚úÖ Found local-deploy.sh"
            bash -n scripts/local-deploy.sh && echo "‚úÖ Script syntax is valid"
          else
            echo "‚ùå Missing local-deploy.sh"
            exit 1
          fi

  verify-readme:
    runs-on: ubuntu-latest
    needs: test-application
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check README
        run: |
          echo "üìñ Checking README..."
          if [ -f "README.md" ]; then
            echo "‚úÖ README.md exists"
            if grep -q "git clone" README.md; then
              echo "‚úÖ README has clone instructions"
            fi
          else
            echo "‚ùå README.md not found"
          fi

  final-success:
    runs-on: ubuntu-latest
    needs: [test-application, test-docker-build, test-deployment-script, verify-readme]
    
    steps:
      - name: Success
        run: |
          echo "üéâ All tests passed!"
          echo "‚úÖ Application works"
          echo "‚úÖ Docker builds"
          echo "‚úÖ Deployment script is valid"
          echo "‚úÖ README is present"
